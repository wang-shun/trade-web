<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.centaline.trans.spv.repository.ToSpvMapper" >
  <resultMap id="BaseResultMap" type="com.centaline.trans.spv.entity.ToSpv" >
    <id column="PKID" property="pkid" jdbcType="BIGINT" />
    <result column="CASE_CODE" property="caseCode" jdbcType="VARCHAR" />
    <result column="SPV_CODE" property="spvCode" jdbcType="VARCHAR" />
    <result column="SPV_TYPE" property="spvType" jdbcType="NVARCHAR" />
    <result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
    <result column="SPV_INSTI" property="spvInsti" jdbcType="VARCHAR" />
    <result column="SIGN_TIME" property="signTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.centaline.trans.spv.entity.ToSpv" extends="BaseResultMap" >
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    PKID, CASE_CODE, SPV_CODE, SPV_TYPE, AMOUNT, SPV_INSTI, SIGN_TIME
  </sql>
  <sql id="Blob_Column_List" >
    REMARK
  </sql>
  
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from sctrans.T_TO_SPV
    where PKID = #{pkid,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from sctrans.T_TO_SPV
    where PKID = #{pkid,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.centaline.trans.spv.entity.ToSpv" >
    insert into sctrans.T_TO_SPV (PKID, CASE_CODE, SPV_CODE, 
      SPV_TYPE, AMOUNT, SPV_INSTI, 
      SIGN_TIME, REMARK
      )
    values (#{pkid,jdbcType=BIGINT}, #{caseCode,jdbcType=VARCHAR}, #{spvCode,jdbcType=VARCHAR}, 
      #{spvType,jdbcType=NVARCHAR}, #{amount,jdbcType=DECIMAL}, #{spvInsti,jdbcType=VARCHAR}, 
      #{signTime,jdbcType=TIMESTAMP}, #{remark,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.centaline.trans.spv.entity.ToSpv" >
    insert into sctrans.T_TO_SPV
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="pkid != null" >
        PKID,
      </if>
      <if test="caseCode != null" >
        CASE_CODE,
      </if>
      <if test="spvCode != null" >
        SPV_CODE,
      </if>
      <if test="spvType != null" >
        SPV_TYPE,
      </if>
      <if test="amount != null" >
        AMOUNT,
      </if>
      <if test="spvInsti != null" >
        SPV_INSTI,
      </if>
      <if test="signTime != null" >
        SIGN_TIME,
      </if>
      <if test="remark != null" >
        REMARK,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="pkid != null" >
        #{pkid,jdbcType=BIGINT},
      </if>
      <if test="caseCode != null" >
        #{caseCode,jdbcType=VARCHAR},
      </if>
      <if test="spvCode != null" >
        #{spvCode,jdbcType=VARCHAR},
      </if>
      <if test="spvType != null" >
        #{spvType,jdbcType=NVARCHAR},
      </if>
      <if test="amount != null" >
        #{amount,jdbcType=DECIMAL},
      </if>
      <if test="spvInsti != null" >
        #{spvInsti,jdbcType=VARCHAR},
      </if>
      <if test="signTime != null" >
        #{signTime,jdbcType=TIMESTAMP},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.centaline.trans.spv.entity.ToSpv" >
    update sctrans.T_TO_SPV
    <set >
      <if test="caseCode != null" >
        CASE_CODE = #{caseCode,jdbcType=VARCHAR},
      </if>
      <if test="spvCode != null" >
        SPV_CODE = #{spvCode,jdbcType=VARCHAR},
      </if>
      <if test="spvType != null" >
        SPV_TYPE = #{spvType,jdbcType=NVARCHAR},
      </if>
      <if test="amount != null" >
        AMOUNT = #{amount,jdbcType=DECIMAL},
      </if>
      <if test="spvInsti != null" >
        SPV_INSTI = #{spvInsti,jdbcType=VARCHAR},
      </if>
      <if test="signTime != null" >
        SIGN_TIME = #{signTime,jdbcType=TIMESTAMP},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where PKID = #{pkid,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.centaline.trans.spv.entity.ToSpv" >
    update sctrans.T_TO_SPV
    set CASE_CODE = #{caseCode,jdbcType=VARCHAR},
      SPV_CODE = #{spvCode,jdbcType=VARCHAR},
      SPV_TYPE = #{spvType,jdbcType=NVARCHAR},
      AMOUNT = #{amount,jdbcType=DECIMAL},
      SPV_INSTI = #{spvInsti,jdbcType=VARCHAR},
      SIGN_TIME = #{signTime,jdbcType=TIMESTAMP},
      REMARK = #{remark,jdbcType=LONGVARCHAR}
    where PKID = #{pkid,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.centaline.trans.spv.entity.ToSpv" >
    update sctrans.T_TO_SPV
    set CASE_CODE = #{caseCode,jdbcType=VARCHAR},
      SPV_CODE = #{spvCode,jdbcType=VARCHAR},
      SPV_TYPE = #{spvType,jdbcType=NVARCHAR},
      AMOUNT = #{amount,jdbcType=DECIMAL},
      SPV_INSTI = #{spvInsti,jdbcType=VARCHAR},
      SIGN_TIME = #{signTime,jdbcType=TIMESTAMP},
    where PKID = #{pkid,jdbcType=BIGINT}
  </update>
  
  <select id="queryToSpvByCaseCode" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from sctrans.T_TO_SPV
    where CASE_CODE = #{caseCode,jdbcType=VARCHAR}
  </select>
  
  <select id="findToSpvBySpvCode" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from sctrans.T_TO_SPV
    where SPV_CODE = #{spvCode,jdbcType=VARCHAR}
  </select>
  
  <select id="countToSignById"  parameterType="java.lang.String" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   	
		<!-- SELECT 
		   	COUNT(CASE_CODE) AS countQYS
		   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
				IN((SELECT CASE_CODE  FROM  sctrans.T_TO_SIGN WHERE  datediff(month,sctrans.T_TO_SIGN.REAL_CON_TIME,getdate())=0)) 
				AND LEADING_PROCESS_ID = 
		(SELECT 
			DISTINCT
			PROCESSOR_ID 
		FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR 
		WHERE PROCESSOR_ID = #{userId,jdbcType=VARCHAR}) -->
		SELECT 
		   	COUNT(CASE_CODE) AS countQYS
		   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
				IN((SELECT CASE_CODE  FROM  sctrans.T_TO_SIGN WHERE  datediff(month,sctrans.T_TO_SIGN.REAL_CON_TIME,getdate())=0)) 
				AND CASE_CODE IN(
				(
					select CASE_CODE from sctrans.T_TO_CASE
					WHERE 1=1			
					AND LEADING_PROCESS_ID = #{userId,jdbcType=VARCHAR}				
						)UNION(
						SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
						WHERE 1=1
						AND PROCESSOR_ID = #{userId,jdbcType=VARCHAR}  				  	
					)

				)
		
  </select>
  
  <select id="countToSignByOrgId"  parameterType="com.centaline.trans.cases.entity.ToCase" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   		SELECT 
   			COUNT(CASE_CODE) AS countQYS
   		FROM sctrans.T_TO_CASE WHERE CASE_CODE 
		IN((SELECT CASE_CODE  FROM  sctrans.T_TO_SIGN WHERE  datediff(month,sctrans.T_TO_SIGN.REAL_CON_TIME,getdate())=0)) 
		<if test="startDate != null">
     		 AND   CREATE_TIME &gt;= #{startDate,jdbcType=VARCHAR}  
    	</if>
		<if test="endDate != null">
      		AND  CREATE_TIME  &lt;= #{endDate,jdbcType=VARCHAR}  
    	</if>
		<if test="orgId != null" >
			 AND  CASE_CODE IN(
			(
				select CASE_CODE from sctrans.T_TO_CASE
				WHERE 1=1			
				AND ORG_ID = #{orgId,jdbcType=VARCHAR}	
					)UNION(
					SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
					WHERE 1=1
					AND  ORG_ID = #{orgId,jdbcType=VARCHAR}				  	
				)
		
			)
      </if>
		
  </select>
  
  <select id="queryCountToSignById"  parameterType="com.centaline.trans.cases.entity.ToCase" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   	SELECT 
   		COUNT(CASE_CODE) AS countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE  FROM   sctrans.T_TO_SIGN	WHERE 	convert(char(7) ,sctrans.T_TO_SIGN.REAL_CON_TIME , 120) = #{time,jdbcType=VARCHAR} )) 
	
	AND LEADING_PROCESS_ID = #{leadingProcessId,jdbcType=VARCHAR}

  </select>
  

  
  <select id="queryCountToSignByOrg"  parameterType="com.centaline.trans.cases.entity.ToCase" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   	SELECT 
   		COUNT(CASE_CODE) AS countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE  FROM   sctrans.T_TO_SIGN	WHERE 	convert(char(7) ,sctrans.T_TO_SIGN.REAL_CON_TIME , 120) = #{time,jdbcType=VARCHAR} )) 
	
	<if test="orgId != null" >
		<!-- AND ORG_ID = #{orgId,jdbcType=VARCHAR}  -->
		AND  CASE_CODE IN(
	(
		select CASE_CODE from sctrans.T_TO_CASE
		WHERE 1=1			
		AND ORG_ID = #{orgId,jdbcType=VARCHAR}
			)UNION(
			SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
			WHERE 1=1
			AND  ORG_ID = #{orgId,jdbcType=VARCHAR}				  	
		)

	)
    </if>

  </select>
  
  <select id="countToSignListByOrgId"  parameterType="com.centaline.trans.cases.entity.ToCase" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   	<!-- SELECT 
   		convert(char(7) ,CREATE_TIME , 120) as  createTime,
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	<if test="orgId != null">
      AND  ORG_ID = #{orgId,jdbcType=VARCHAR}
    </if>
	GROUP BY convert(char(7) ,CREATE_TIME , 120) -->
	SELECT 
   		convert(char(7) ,CREATE_TIME , 120) as  createTime,
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  CASE_CODE IN (
   	SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
		WHERE 1=1
		<if test="orgId != null">
      		AND  ORG_ID = #{orgId,jdbcType=VARCHAR}
   		</if>
	)
	GROUP BY convert(char(7) ,CREATE_TIME , 120)
	

  </select>
  <select id="countToSignListByOrgList" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
  
	SELECT 
   		convert(char(7) ,CREATE_TIME , 120) as  createTime,
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  CASE_CODE IN (
   	SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
		WHERE 1=1
		AND  ORG_ID  IN
		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">#{item}</foreach>
	)
	GROUP BY convert(char(7) ,CREATE_TIME , 120)

  </select>
  <select id="countToSignListByIdList" resultType="com.centaline.trans.cases.entity.ToCaseInfoCountVo">
   	SELECT 
   		convert(char(7) ,CREATE_TIME , 120) as  createTime,
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  LEADING_PROCESS_ID IN
    <foreach collection="list" item="item" index="index" open="(" separator="," close=")">#{item}</foreach>

	GROUP BY convert(char(7) ,CREATE_TIME , 120)

  </select>
  
  <select id="countToSignByOrgList" resultType="java.lang.Integer">
   	SELECT 
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  CASE_CODE IN(
	(
		select CASE_CODE from sctrans.T_TO_CASE
		WHERE 1=1			
		AND ORG_ID IN 
		<foreach collection="param1" item="item1" index="index1" open="(" separator="," close=")">#{item1}</foreach>
		<if test="param2 != null">
	      AND   CREATE_TIME &gt;= #{param2,jdbcType=VARCHAR}   
	    </if>
		<if test="param3 != null">
	      AND  CREATE_TIME  &lt;= #{param3,jdbcType=VARCHAR}  
	    </if>
			)UNION(
			SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
			WHERE 1=1
			AND  ORG_ID IN 
	  	<foreach collection="param1" item="item1" index="index1" open="(" separator="," close=")">#{item1}</foreach>
		<if test="param2 != null">
	      AND   CREATE_TIME &gt;= #{param2,jdbcType=VARCHAR}   
	    </if>
		<if test="param3 != null">
	      AND  CREATE_TIME  &lt;= #{param3,jdbcType=VARCHAR}  
	    </if>
		)
	)

  </select>
  <select id="countToSignByIdList" resultType="java.lang.Integer">
   	SELECT 
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  CASE_CODE IN(
	(
		select CASE_CODE from sctrans.T_TO_CASE
		WHERE 1=1			
		AND LEADING_PROCESS_ID IN 
		<foreach collection="param1" item="item1" index="index1" open="(" separator="," close=")">#{item1}</foreach>
		<if test="param2 != null">
	      AND   CREATE_TIME &gt;= #{param2,jdbcType=VARCHAR}   
	    </if>
		<if test="param3 != null">
	      AND  CREATE_TIME  &lt;= #{param3,jdbcType=VARCHAR}  
	    </if>
			)UNION(
			SELECT CASE_CODE FROM sctrans.T_TG_SERV_ITEM_AND_PROCESSOR
			WHERE 1=1
			AND  LEADING_PROCESS_ID IN 
	  	<foreach collection="param1" item="item1" index="index1" open="(" separator="," close=")">#{item1}</foreach>
		<if test="param2 != null">
	      AND   CREATE_TIME &gt;= #{param2,jdbcType=VARCHAR}   
	    </if>
		<if test="param3 != null">
	      AND  CREATE_TIME  &lt;= #{param3,jdbcType=VARCHAR}  
	    </if>
		)
	)

  </select>
  
  <select id="initCountToSignByOrgId" parameterType="com.centaline.trans.cases.entity.ToCase" resultType="java.lang.Integer">
   	SELECT 
   		COUNT(CASE_CODE) as countQYS
   	FROM sctrans.T_TO_CASE WHERE CASE_CODE 
	IN((SELECT CASE_CODE FROM   sctrans.T_TO_SIGN	WHERE  PART_CODE is not  null and  datediff(year,CREATE_TIME,getdate())=0 ) )
	AND  CASE_CODE IN(
		(SELECT
				DISTINCT c.CASE_CODE
			FROM sctrans.T_TO_CASE c
			INNER JOIN sctrans.SYS_ORG o
			ON  c.ORG_ID=o.ID 
			WHERE  
				datediff(month,CREATE_TIME,getdate())=0
			<if test="orgId != null">
			AND o.PARENT_ID= #{orgId,jdbcType=VARCHAR}   
			</if>
			<!-- AND o.ID='1762F675CE17459EA9B696F90AEB74F5' -->
		)
		UNION
		(SELECT
				DISTINCT s.case_code
			FROM sctrans.T_TO_CASE c
			LEFT JOIN sctrans.SYS_ORG o
			<if test="orgId != null">
			ON o.PARENT_ID=#{orgId,jdbcType=VARCHAR}  
			</if>
			<!-- ON o.ID='1762F675CE17459EA9B696F90AEB74F5' -->
			LEFT JOIN sctrans.T_TG_SERV_ITEM_AND_PROCESSOR s
			ON s.ORG_ID=o.ID
			WHERE
				datediff(month,CREATE_TIME,getdate())=0
		)
	)
	<if test="time != null">
	   AND convert(char(7) ,CREATE_TIME , 120) = #{time,jdbcType=VARCHAR} 
	</if>

  </select>
  
</mapper>