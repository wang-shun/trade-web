<?xml version="1.0" encoding="UTF-8"?>
<querys>
	<dicts>
		<customDict id="getStatusByCode" beanName="qqcdDictass_status"></customDict>
		<customDict id="qqcdMortName" beanName="qqcdMortName"></customDict>
		<customDict id="qqcdOrgIdName" beanName="qqcdOrgIdName"></customDict>
		<customDict id="qqcdUserIdName" beanName="qqcdUserIdName"></customDict>
		<customDict id="qqManagerInfo" beanName="qqManagerInfo"></customDict>	
	</dicts>
	
  	<formatters>
		<formatter id="dateFormatter" ref="" class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd HH:mm</property>
			</properties>
		</formatter>
		<formatter id="numberFormater" ref="" class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="groupingUsed">true</property>
				<property name="maximumFractionDigits">3</property>
				<property name="maximumIntegerDigits">40</property>
				<property name="minimumFractionDigits">0</property>
				<property name="minimumIntegerDigits">1</property>
			</properties>
		</formatter>
		<formatter id="integerFormater" ref="" class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="maximumFractionDigits">0</property>
			</properties>
		</formatter>
		<formatter id="emailFormater" ref="" class="com.aist.common.quickQuery.formatter.EmailFormatter"/>
	</formatters>
	
	<query id="queryMortgageApproveLost">
		<searchCondition>
		   <condition field="taskInst.END_TIME_"    name="startDate" label="" searchType="GTE" showType="" showCallback="" defaultValue=""/>
           <condition field="taskInst.END_TIME_"    name="endDate" label="" searchType="LTE" showType="" showCallback="" defaultValue=""/>
           <condition field="base.CASE_CODE"   		name="caseCode" label="" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
           <condition field="base.PROPERTY_ADDR"   name="propertyAddr" label="" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
           <condition field="U.REAL_NAME"   		name="caseoperator"  label="" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
        </searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
					SELECT
					  base.PKID,
					  base.CASE_CODE,
					  base.CTM_CODE,
					  base.PROPERTY_ADDR,
					  base.AGENT_NAME,
					  base.AGENT_PHONE,
					  base.GRP_NAME,
					  base.LEADING_PROCESS_ID AS LEADING_PROCESS_ID_OLD,
					  base.ORG_ID AS ORG_ID_OLD,					
					  mortgage.MORT_TYPE AS MORT_TYPE_OLD,
					  mortgage.SIGN_DATE,
					  guser.real_name,
					  taskInst.END_TIME_,
					  taskInst.START_TIME_,
					  U.REAL_NAME CASEOPERATOR,
					  (SELECT SU.ORG_ID FROM sctrans.SYS_USER SU WHERE SU.ID=base.AGENT_CODE AND SU.IS_DELETED=0) ORG_ID
					FROM 
					
					(SELECT * FROM sctrans.T_TO_MORTGAGE WHERE IS_ACTIVE = 1 AND IS_DELEGATE_YUCUI = 0 AND  (MORT_TYPE IN ('30016001','30016002','') OR MORT_TYPE IS NULL)) mortgage
					INNER JOIN sctrans.V_CASE_LIST_BASE base	ON  mortgage.CASE_CODE = base.CASE_CODE
					INNER JOIN sctrans.SYS_USER u 				ON u.ID = base.LEADING_PROCESS_ID
					INNER JOIN sctrans.T_HI_WORKFLOW w 			ON base.CASE_CODE = w.CASE_CODE
					AND w.BUSINESS_KEY = 'operation_process'
					AND w.STATUS IN ('0', '4')
					AND w.PKID = (select max(PKID) from sctrans.T_HI_WORKFLOW WHERE CASE_CODE = w.CASE_CODE AND BUSINESS_KEY = 'operation_process' AND STATUS IN ('0', '4'))
					INNER JOIN sctrans.ACT_HI_TASKINST taskInst ON taskInst.PROC_INST_ID_ = w.INST_CODE
					AND taskInst.task_def_key_ in ('LoanlostApproveDirector') 
					AND taskInst.ID_ = (SELECT MAX(ID_) FROM sctrans.ACT_HI_TASKINST WHERE PROC_INST_ID_ = taskInst.PROC_INST_ID_
					AND task_def_key_ in ('LoanlostApproveDirector'))
					INNER JOIN sctrans.sys_user guser 
					ON guser.username = taskInst.ASSIGNEE_ 
					AND guser.available = '1'
					AND guser.is_deleted = '0'
					where
						(  EXISTS ( SELECT 1 FROM SCTRANS.T_TO_CASE C 
								    INNER JOIN   sctrans.v_yucui_org_hierarchy orgHierarchy
							        ON  orgHierarchy.ORG_ID = C.ORG_ID
								  	WHERE C.CASE_CODE = base.CASE_CODE  
					  	    		<ifNotNull idflag> 
					  	    				AND C.LEADING_PROCESS_ID = #userId# 	
					  	    		</ifNotNull>
					  	    		<ifNotNull queryorgs> 
					  	    	 			AND (orgHierarchy.TEAM_ID=#queryorgs# or orgHierarchy.DISTRICT_ID=#queryorgs# or orgHierarchy.hq_id=#queryorgs#)
					  	   			 </ifNotNull>
					  	   			 )
					)
					  <if test="srvCode!=null">
						AND (
						   1=2
							<if test="srvCode.contains('NULL')"> 
							 or	(mortgage.MORT_TYPE ='' or mortgage.mort_type is null)					
							</if>
							<if test="srvCode.contains('30016001')"> 
							 or	( mortgage.mort_type ='30016001')					
							</if>
							<if test="srvCode.contains('30016002')"> 
							 or	( mortgage.mort_type ='30016002')					
							</if>
					 	)
					 </if>
					
				]]>
			
			</baseSql>
			<groupSql>
			</groupSql>
			<orderBySql>
			</orderBySql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="PKID" index="" checkbox="true" title="案件ID" display="案件ID" customDict="" sysDict="" format="" width="0" isSort="" align="" halign="" order="" resizable="" hide="true"/>
				<column type="both" name="CASE_CODE" index="" checkbox="true" title="案件编号" display="案件编号" customDict="" sysDict="" format="" width="0" isSort="" align="" halign="" order="" resizable="" hide="true"/>
				<column type="both" name="CTM_CODE" index="" checkbox="true" title="CTM编号" display="CTM编号" customDict="" sysDict="" format="" width="0" isSort="" align="" halign="" order="" resizable="" hide="true"/>
				<column type="both" name="PROPERTY_ADDR" index="" checkbox="" title="产证地址" display="产证地址" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="both" name="LEADING_PROCESS_ID_OLD" index="" checkbox="" title="主办" display="主办" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="virtual" name="LEADING_PROCESS_ID" title="主办" display="主办" referencecol="LEADING_PROCESS_ID_OLD"  customDict="qqcdUserIdName" isSort="true" order="desc"/>
				<column type="both" name="ORG_ID_OLD" index="" checkbox="" title="交易顾问组织id" display="主办组" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="both" name="ORG_ID" index="" checkbox="" title="经纪人组织id" display="经纪人组织id" customDict="" sysDict="" format="" width="" isSort="" align="" halign="" order="" resizable=""/>
				<!-- <column type="virtual" name="ORG_ID" title="主办组" display="主办组" referencecol="ORG_ID_OLD"  customDict="qqcdOrgIdName" isSort="true" order="desc"/> -->
				<column type="both" name="AGENT_NAME" index="" checkbox="" title="经纪人" display="经纪人" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="both" name="AGENT_PHONE" index="" checkbox="" title="经纪人电话" display="经纪人电话" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="both" name="GRP_NAME" index="" checkbox="" title="经纪人组别" display="经纪人组别" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="both" name="MORT_TYPE_OLD" index="" checkbox="" title="贷款类型" display="贷款类型" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="virtual" name="MORT_TYPE"  title="贷款类型" display="贷款类型" referencecol="MORT_TYPE_OLD"  customDict="qqcdMortName" isSort="true" order="desc"/>
				<column type="both" name="real_name" index="" checkbox="" title="审批人" display="审批人" customDict="" sysDict="" width="150" isSort="true" align="" halign="" order="" resizable=""/>
				<column type="both" name="END_TIME_" index="" checkbox="" title="审批时间"  display="审批时间" customDict="" sysDict="" beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm"  format="" width="150" isSort="true" align="" halign="" order="" resizable="" />
				<column type="both" name="START_TIME_" index="" checkbox="" title="创建时间"  display="创建时间" customDict="" sysDict="" beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm"  format="" width="150" isSort="true" align="" halign="" order="" resizable="" />
				<column type="both" name="CASEOPERATOR" index="" checkbox="" title="主办人" display="主办人" customDict="" sysDict="" format="" width="150" isSort="true" align="" halign="" order="desc" resizable=""/>
				<column type="virtual" name="MANAGER_INFO" referencecol="ORG_ID" index="" checkbox="" display="" customDict="qqManagerInfo" sysDict="" format="" width="" isSort="true" align="" halign="" order="" resizable="" />
			</table-row>
		</grid>
	</query>
</querys>