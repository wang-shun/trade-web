<?xml version="1.0" encoding="UTF-8"?>
<querys>
	<dicts>
		<customDict id="convertValue" beanName="convertValue"></customDict>
		<customDict id="qqcdSeller" beanName="qqcdSeller" />
		<customDict id="qqcdBuyer" beanName="qqcdBuyer" />
		<customDict id="qqcdProcessorName" beanName="qqcdProcessorName"></customDict>
		<customDict id="qqcdSellerPhone" beanName="qqcdSellerPhone" />
		<customDict id="qqcdBuyerPhone" beanName="qqcdBuyerPhone" />
	</dicts>
	<formatters>
		<formatter id="dateFormatter" ref=""
			class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd HH:mm:ss</property>
			</properties>
		</formatter>
		<formatter id="numberFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="groupingUsed">true</property>
				<property name="maximumFractionDigits">3</property>
				<property name="maximumIntegerDigits">40</property>
				<property name="minimumFractionDigits">0</property>
				<property name="minimumIntegerDigits">1</property>
			</properties>
		</formatter>
		<formatter id="integerFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="maximumFractionDigits">0</property>
			</properties>
		</formatter>
		<formatter id="emailFormater" ref=""
			class="com.aist.common.quickQuery.formatter.EmailFormatter" />
	</formatters>
	<query id="queryCastTransferExcelItemList" cacheCount="true">
		<searchCondition>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
				select 					
					distinct(CASE_CODE), 
					PKID,
					CTM_CODE,
					PROPERTY_ADDR ,
					T.REAL_NAME , 
					T.ORG_NAME, 
					transferDate, 
					caseTransferDate , 
					status,
					GRP_NAME, 
					AR_NAME ,  
					wz.ORG_NAME AS VORG_NAME , 
					WZ.REAL_NAME AS VREAL_NAME  
				from (
					select c.pkid,c.case_code,c.CTM_CODE, p.PROPERTY_ADDR , zg.REAL_NAME, zg.ORG_NAME, i.AR_NAME, i.GRP_CODE,I.GRP_NAME, 
					(select top 1 tgh.end_time_ from sctrans.act_hi_taskinst tgh where w.INST_CODE = tgh.proc_inst_id_ and tgh.task_def_key_='Guohu' order by id_ desc) transferDate , 
					(select top 1 tgha.end_time_ from sctrans.act_hi_taskinst tgha where w.INST_CODE = tgha.proc_inst_id_ and tgha.task_def_key_='GuohuApprove' order by id_ desc) caseTransferDate, 
					v.long_ AS  status
					from sctrans.t_to_case c 
					inner join sctrans.T_TO_PROPERTY_INFO p on c.CASE_CODE = p.CASE_CODE 
					left join sctrans.V_USER_ORG_JOB zg on c.ORG_ID = zg.ORG_ID and zg.JOB_CODE ='manager'
					inner join sctrans.T_TO_CASE_info i on c.case_code = i.case_code
					inner join sctrans.T_TO_WORKFLOW w on c.case_code = w.case_code 
					and  w.BUSINESS_KEY = 'operation_process' and w.STATUS in (0, 4)
					inner join sctrans.act_hi_varinst v on v.PROC_INST_ID_ = w.INST_CODE AND v.name_='GuohuApprove') t 
					LEFT JOIN SCTRANS.SYS_ORG O ON T.GRP_CODE = O.ORG_CODE
					LEFT JOIN SCTRANS.T_SYS_ORG_HIERARCHY OH ON O.ID = OH.ORG_ID
					LEFT JOIN SCTRANS.V_USER_ORG_JOB WZ ON WZ.ORG_ID = OH.BUSIWZ_ID AND WZ.JOB_CODE = 'JQYDS' AND WZ.IS_LEADER = 1
					where 1=1
					 <ifNotNull caseTransferDateStart>
						AND t.caseTransferDate &gt; #caseTransferDateStart#
					</ifNotNull>
					<ifNotNull caseTransferDateEnd>
						AND t.caseTransferDate &lt; #caseTransferDateEnd#
					</ifNotNull>					
					<ifNotNull transferDateStart>
						AND t.transferDate &gt; #transferDateStart#
					</ifNotNull>
					<ifNotNull transferDateEnd>
						AND t.transferDate &lt; #transferDateEnd#
					</ifNotNull>
					<ifNotNull orgName>
						AND T.ORG_NAME like '%' + #orgName# + '%' 
					</ifNotNull>
					<ifNotNull TransferStatus>
						AND status = #TransferStatus#
					</ifNotNull>
					<ifNotNull vrealName>
						AND WZ.REAL_NAME like '%' + #vrealName# + '%' 
					</ifNotNull>
					<ifNotNull managerName>
						AND T.REAL_NAME like '%' + #managerName# + '%' 
					</ifNotNull>
					<ifNotNull caseCode>
						AND CASE_CODE = #caseCode#
					</ifNotNull>
					<ifNotNull propertyAddr>
						AND PROPERTY_ADDR like '%' + #propertyAddr# + '%' 
					</ifNotNull>
				]]>
			</baseSql>
			<orderBySql>
				ORDER BY transferDate DESC,caseTransferDate DESC
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="CASE_CODE" title="案件编号" customDict=""
					hidden="false" />
				<column type="both" name="CTM_CODE" title="CTM编号" customDict=""
					hidden="false" />
				<column type="both" name="PKID" index="" checkbox="" display="案件ID"
					customDict="" sysDict="" format="" width="90" isSort="" align=""
					halign="" order="" resizable="" />
				<column type="both" name="PROPERTY_ADDR" title="产证地址"
					customDict="" hidden="false" />
				<column type="both" name="REAL_NAME" title="主管" customDict=""
					hidden="false" />
				<column type="both" name="ORG_NAME" title="组别" customDict=""
					hidden="false" />
				<column type="both" name="transferDate" title="过户时间"
					customDict="" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" hidden="false" />
				<column type="both" name="caseTransferDate" title="过户审批时间"
					customDict="" hidden="false" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="status" title="是否审批通过" customDict=""
					hidden="false" />
				<column type="virtual" name="status1" title="是否审批通过"
					referencecol="status" customDict="convertValue" />
				<column type="both" name="GRP_NAME" title="店组" customDict=""
					hidden="false" />
				<column type="both" name="AR_NAME" title="片区" customDict=""
					hidden="false" />
				<column type="both" name="VORG_NAME" title="区域" customDict=""
					hidden="false" />
				<column type="both" name="VREAL_NAME" title="区董" customDict=""
					hidden="false" />

				<column type="virtual" name="SELLER" title="上家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="上家"
					customDict="qqcdSeller" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER" title="下家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="下家"
					customDict="qqcdBuyer" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="PROCESSOR_ID" title="经办人"
					referencecol="CASE_CODE" index="" checkbox="" display="经办人"
					customDict="qqcdProcessorName" sysDict="" format="" width="60"
					isSort="true" align="" halign="" order="" resizable="" />
				<column type="virtual" name="SELLER_MOBILE" title="上家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="上家电话"
					customDict="qqcdSellerPhone" sysDict="" format="" width="60"
					isSort="true" align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER_MOBILE" title="下家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="下家电话"
					customDict="qqcdBuyerPhone" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />

			</table-row>
		</grid>
	</query>



	<query id="newQueryCastTransferExcelItemList" cacheCount="true">
		<searchCondition>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
				SELECT
					DISTINCT(T.CASE_CODE),	
					T.BIGAREA,
					T.AGENT_ORG_NAME,
					T.AGENT_NAME,
					T.GUOHU_ORG_NAME,
					T.GUOHU_REAL_NAME,
					T.GUOHUDJ,
					T.dist_name,
					T.REAL_HT_TIME,
					T.CTM_CODE,
					T.CUST_NAME,
					T.GUEST_PHONE,
					T.PROPERTY_ADDR,
					T.CON_PRICE,
					T.FIN_ORG_NAME,
					T.FIN_ORG_NAME_YC,
					T.COM_AMOUNT,
					T.PRF_AMOUNT,
					T.ACCOUNT,
					T.COM_DISCOUNT,
					T.LOANER_NAME,
					T.LOANER_PHONE,
					T.SDSTATUS,
					T.IS_LOANER_ARRIVE,
					T.transferDate,
					T.caseTransferDate,
					T.ASSESSOR,			
					<!-- T.ISAPPROVE, -->
					T.status,
					T.CONTENT,
					T.MANAGER_REAL_NAME,
					T.MANAGER_ORG_NAME,
					GRP_NAME, 
					MANAGER_AR_NAME,  
					WZ.ORG_NAME, 
					WZ.REAL_NAME 
				FROM (		
						select	
							C.CASE_CODE,	
							C.CTM_CODE,		
							(SELECT (SELECT TOP 1 ORG_NAME FROM SCTRANS.SYS_Org WHERE ID = H.BUSIBA_Id) 	FROM [SCTRANS].[T_SYS_ORG_HIERARCHY] H WHERE GROUP_ID =v.ORG_ID) AS BIGAREA,			
							CF.AGENT_NAME, 	
							V.ORG_NAME as AGENT_ORG_NAME,		
							M.COM_AMOUNT,	
							M.PRF_AMOUNT,
							M.COM_DISCOUNT,
							M.COM_AMOUNT+m.PRF_AMOUNT as ACCOUNT,
							M.LOANER_NAME,
							M.LOANER_PHONE,
							M.CUST_NAME,  
							PR.GUEST_PHONE,			
							case when M.IS_LOANER_ARRIVE=1 then '是' when M.IS_LOANER_ARRIVE = 0 then '否' end   IS_LOANER_ARRIVE,	
							(select TOP 1 TF.FIN_ORG_NAME FROM SCTRANS.T_TS_FIN_ORG TF WHERE TF.FIN_ORG_CODE= M.FIN_ORG_CODE ) FIN_ORG_NAME,  
							(select TOP 1 TF.FIN_ORG_NAME_YC FROM SCTRANS.T_TS_FIN_ORG TF WHERE TF.FIN_ORG_CODE= M.FIN_ORG_CODE ) FIN_ORG_NAME_YC,  
							case 
								when C.LOAN_REQ=1 and m.MORT_TYPE in('30016001','30016002') and m.IS_DELEGATE_YUCUI=1   then '收单' 
								when C.LOAN_REQ=1 and m.MORT_TYPE in('30016001','30016002') and m.IS_DELEGATE_YUCUI=0   then '流失' end   SDSTATUS,				
							
							VJ.ORG_NAME as GUOHU_ORG_NAME,	   
							VJ.REAL_NAME as GUOHU_REAL_NAME,   
				
							case 			       	/*计算过户单价、保留2位小数、考虑面积为0和null的情况*/
							WHEN  p.SQUARE = 0		then  ROUND(CONVERT(float,s.REAL_PRICE)/CONVERT(float,1),2) 	
							ELSE  ROUND(CONVERT(float,s.REAL_PRICE)/ISNULL(CONVERT(float,p.SQUARE),1),2)
							END  GUOHUDJ,
								
							PM.dist_name,			/*过户区域*/
							(select TOP 1 HT.REAL_HT_TIME FROM SCTRANS.T_TO_HOUSE_TRANSFER HT WHERE HT.CASE_CODE= C.CASE_CODE ) REAL_HT_TIME,  /*实际过户时间 可优化*/	
							S.CON_PRICE, 						 /*合同金额   可优化*/
							P.PROPERTY_ADDR,					 /*产证地址*/
							V2.REAL_NAME AS  MANAGER_REAL_NAME,  /*主管姓名*/
							V2.ORG_NAME  AS MANAGER_ORG_NAME,   /*主管所在组别*/
							CF.AR_NAME AS MANAGER_AR_NAME,		/*主管所在区域*/
							CF.GRP_CODE,
							CF.GRP_NAME, 
							(select TOP 1 REAL_NAME from SCTRANS.V_USER_ORG_JOB where USER_ID=AR.OPERATOR  AND AR.PART_CODE='GuohuApprove') AS ASSESSOR,
							(select TOP 1 A.CONTENT from SCTRANS.T_TO_APPROVE_RECORD A where C.CASE_CODE=A.CASE_CODE  AND AR.PART_CODE='GuohuApprove') AS CONTENT,
							(select top 1 tgh.end_time_ from SCTRANS.act_hi_taskinst tgh where w.INST_CODE = tgh.proc_inst_id_ and tgh.task_def_key_='Guohu' order by id_ desc) AS transferDate , 
							(select top 1 tgha.end_time_ from SCTRANS.act_hi_taskinst tgha where w.INST_CODE = tgha.proc_inst_id_ and tgha.task_def_key_='GuohuApprove' order by id_ desc) AS caseTransferDate, 
							hv.long_ as status
						
						from SCTRANS.T_TO_CASE C 		
							LEFT JOIN SCTRANS.T_TO_CASE_INFO CF on C.CASE_CODE=CF.CASE_CODE  /*关联查询 三级市场相应信息*/
							INNER JOIN SCTRANS.V_USER_ORG_JOB V on  CF.AGENT_USERNAME=V.USERNAME /*关联查询 三级市场人员对应的组别信息*/
							INNER JOIN SCTRANS.T_TO_MORTGAGE M on C.CASE_CODE = M.CASE_CODE	 /*贷款、按揭方面的所有信息*/
							INNER JOIN SCTRANS.T_TS_FIN_ORG FO on M.FIN_ORG_CODE = FO.FIN_ORG_CODE /*关联贷款机构 查询银行、分行信息*/
							INNER JOIN SCTRANS.T_TG_GUEST_INFO PR on M.CUST_CODE=PR.PKID	/*关联客户表查询主贷人信息*/			
							INNER JOIN SCTRANS.T_SYS_ORG_HIERARCHY SOH on v.ORG_ID=SOH.GROUP_ID	/*查询大区*/
				
							LEFT JOIN SCTRANS.T_TO_WORKFLOW W on C.CASE_CODE = w.case_code  and  w.BUSINESS_KEY = 'operation_process' and w.STATUS in (0, 4)
							INNER JOIN SCTRANS.ACT_HI_TASKINST AHT on W.INST_CODE=AHT.PROC_INST_ID_ AND AHT.TASK_DEF_KEY_ ='Guohu'--IN ('Guohu','GuohuApprove')	/*关联工作流，查询过户操作员*/
							INNER JOIN SCTRANS.V_USER_ORG_JOB VJ on  aht.ASSIGNEE_=VJ.USERNAME
				
							INNER JOIN SCTRANS.T_TO_PROPERTY_INFO P on C.CASE_CODE=P.CASE_CODE /*关联物业信息，查询产权地址*/
							INNER JOIN SCTRANS.T_TS_PR_RESEARCH_MAP PM on P.DIST_CODE=PM.dist_code /* 关联基本区域，查询产调区域信息*/
							INNER JOIN SCTRANS.T_TO_SIGN S on C.CASE_CODE=S.CASE_CODE /* 关联签约，查询合同金额*/	
							LEFT JOIN SCTRANS.V_USER_ORG_JOB V2 on C.ORG_ID = V2.ORG_ID and V2.JOB_CODE ='manager' /* 查询CASE的主管信息*/			
							LEFT JOIN SCTRANS.act_hi_varinst hv on hv.PROC_INST_ID_ = w.INST_CODE AND hv.name_='GuohuApprove'
							LEFT JOIN SCTRANS.T_TO_APPROVE_RECORD AR on C.CASE_CODE=AR.CASE_CODE  AND AR.PART_CODE='GuohuApprove' --内连接和左连接的区别			 
							)T  	
							LEFT JOIN SCTRANS.SYS_ORG O ON T.GRP_CODE = O.ORG_CODE
							LEFT JOIN SCTRANS.T_SYS_ORG_HIERARCHY OH ON O.ID = OH.ORG_ID
							LEFT JOIN SCTRANS.V_USER_ORG_JOB WZ ON WZ.ORG_ID = OH.BUSIWZ_ID AND WZ.JOB_CODE = 'JQYDS' AND WZ.IS_LEADER = 1
					where 1=1
					 <ifNotNull caseTransferDateStart>
						AND t.caseTransferDate &gt; #caseTransferDateStart#
					</ifNotNull>
					<ifNotNull caseTransferDateEnd>
						AND t.caseTransferDate &lt; #caseTransferDateEnd#
					</ifNotNull>					
					<ifNotNull transferDateStart>
						AND t.transferDate &gt; #transferDateStart#
					</ifNotNull>
					<ifNotNull transferDateEnd>
						AND t.transferDate &lt; #transferDateEnd#
					</ifNotNull>
					<ifNotNull caseCode>
						AND CASE_CODE = #caseCode#
					</ifNotNull>					
					<ifNotNull orgName>
						AND T.MANAGER_ORG_NAME like '%' + #orgName# + '%' 
					</ifNotNull>
					<ifNotNull TransferStatus>
						AND status = #TransferStatus#
					</ifNotNull>
					<ifNotNull vrealName>
						AND WZ.REAL_NAME like '%' + #vrealName# + '%' 
					</ifNotNull>
					<ifNotNull managerName>
						AND T.MANAGER_REAL_NAME like '%' + #managerName# + '%' 
					</ifNotNull>
					<ifNotNull propertyAddr>
						AND PROPERTY_ADDR like '%' + #propertyAddr# + '%' 
					</ifNotNull>
				]]>
			</baseSql>
			<orderBySql>
				ORDER BY transferDate DESC,caseTransferDate DESC
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="BIGAREA" title="大区" customDict=""
					hidden="false" />
				<column type="both" name="AGENT_ORG_NAME" title="分行"
					customDict="" hidden="false" />
				<column type="both" name="AGENT_NAME" title="业务员姓名"
					customDict="" hidden="false" />
				<column type="both" name="GUOHU_ORG_NAME" title="贵宾服务部"
					customDict="" hidden="false" />
				<column type="both" name="GUOHU_REAL_NAME" title="过户交易员"
					customDict="" hidden="false" />
				<column type="both" name="GUOHUDJ" title="过户单价" customDict=""
					hidden="false" />
				<column type="both" name="dist_name" title="过户区域" customDict=""
					hidden="false" />
				<column type="both" name="REAL_HT_TIME" title="实际过户时间"
					customDict="" beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd"
					hidden="false" />
				<column type="both" name="CTM_CODE" title="CTM编号" customDict=""
					hidden="false" />
				<column type="both" name="CUST_NAME" title="主贷人姓名"
					customDict="" hidden="false" />
				<column type="both" name="GUEST_PHONE" title="主贷人电话"
					customDict="" hidden="false" />
				<column type="both" name="PROPERTY_ADDR" title="产权地址"
					customDict="" hidden="false" />
				<column type="both" name="CON_PRICE" title="合同价" customDict=""
					hidden="false" />
				<column type="both" name="FIN_ORG_NAME" title="银行"
					customDict="" hidden="false" />
				<column type="both" name="FIN_ORG_NAME_YC" title="支行"
					customDict="" hidden="false" />
				<column type="both" name="COM_AMOUNT" title="商贷金额"
					customDict="" hidden="false" />
				<column type="both" name="PRF_AMOUNT" title="公积金金额"
					customDict="" hidden="false" />
				<column type="both" name="ACCOUNT" title="贷款总额" customDict=""
					hidden="false" />
				<column type="both" name="COM_DISCOUNT" title="贷款利率"
					customDict="" hidden="false" />
				<column type="both" name="CASE_CODE" title="誉萃编号" customDict=""
					hidden="false" />
				<column type="both" name="LOANER_NAME" title="货代专员"
					customDict="" hidden="false" />
				<column type="both" name="LOANER_PHONE" title="专员电话"
					customDict="" hidden="false" />
				<column type="both" name="SDSTATUS" title="收单状况" customDict=""
					hidden="false" />
				<column type="both" name="IS_LOANER_ARRIVE" title="是否到场"
					customDict="" hidden="false" />
				<column type="virtual" name="SELLER" title="上家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="上家"
					customDict="qqcdSeller" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="SELLER_MOBILE" title="上家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="上家电话"
					customDict="qqcdSellerPhone" sysDict="" format="" width="60"
					isSort="true" align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER" title="下家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="下家"
					customDict="qqcdBuyer" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER_MOBILE" title="下家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="下家电话"
					customDict="qqcdBuyerPhone" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="both" name="transferDate" title="过户时间"
					customDict="" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" hidden="false" />
				<column type="both" name="caseTransferDate" title="过户审批时间"
					customDict="" hidden="false" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="ASSESSOR" title="审核人" customDict=""
					hidden="false" />
				<column type="both" name="status" title="是否审批通过" customDict=""
					hidden="false" />
				<column type="virtual" name="status1" title="是否审批通过"
					referencecol="status" customDict="convertValue" />
				<column type="both" name="CONTENT" title="审核结果" customDict=""
					hidden="false" />
<!-- 					
				<column type="both" name="ISAPPROVE" title="是否审批通过"
					customDict="" hidden="false" /> -->
				<column type="both" name="PKID" index="" checkbox="" display="案件ID"
					customDict="" sysDict="" format="" width="90" isSort="" align=""
					halign="" order="" resizable="" />
				<column type="both" name="MANAGER_REAL_NAME" title="主管"
					customDict="" hidden="false" />
				<column type="both" name="MANAGER_ORG_NAME" title="主管组别"
					customDict="" hidden="false" />
				<column type="both" name="GRP_NAME" title="店组" customDict=""
					hidden="false" />
				<column type="both" name="MANAGER_AR_NAME" title="片区"
					customDict="" hidden="false" />
				<column type="both" name="ORG_NAME" title="区域" customDict=""
					hidden="false" />
				<column type="both" name="REAL_NAME" title="区董" customDict=""
					hidden="false" />
			</table-row>
		</grid>
	</query>
</querys>

