<?xml version="1.0" encoding="UTF-8"?>
<querys>
	<dicts>
		<customDict id="convertValue" beanName="convertValue" />
		<customDict id="qqcdSeller" beanName="qqcdSeller" />
		<customDict id="qqcdBuyer" beanName="qqcdBuyer" />
		<customDict id="qqcdProcessorName" beanName="qqcdProcessorName" />
		<customDict id="qqcdSellerPhone" beanName="qqcdSellerPhone" />
		<customDict id="qqcdBuyerPhone" beanName="qqcdBuyerPhone" />
	</dicts>
	<formatters>
		<formatter id="newDateFormatter" ref=""
			class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd</property>
			</properties>
		</formatter>
		<formatter id="dateFormatter" ref=""
			class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd HH:mm:ss</property>
			</properties>
		</formatter>
		<formatter id="numberFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="groupingUsed">true</property>
				<property name="maximumFractionDigits">3</property>
				<property name="maximumIntegerDigits">40</property>
				<property name="minimumFractionDigits">0</property>
				<property name="minimumIntegerDigits">1</property>
			</properties>
		</formatter>
		<formatter id="integerFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="maximumFractionDigits">0</property>
			</properties>
		</formatter>
		<formatter id="emailFormater" ref=""
			class="com.aist.common.quickQuery.formatter.EmailFormatter" />
	</formatters>
	
	<query id="newQueryCastTransferExcelItemList" cacheCount="true">
		<searchCondition>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[				
							SELECT					
									distinct(T.CASE_CODE),
									(SELECT (SELECT TOP 1 ORG_NAME FROM SCTRANS.SYS_Org WHERE ID = H.BUSIBA_Id) 	FROM [SCTRANS].[T_SYS_ORG_HIERARCHY] H WHERE GROUP_ID = (select top 1 v.org_id from SCTRANS.V_USER_ORG_JOB v where t.AGENT_USERNAME=V.USERNAME)) AS BIGAREA,
									AGENT_NAME, 
									(select TOP 1 U.ORG_NAME FROM sctrans.V_USER_ORG_JOB U WHERE  T.AGENT_USERNAME=U.USERNAME ) AGENT_ORG_NAME,
									(select top 1 vj.real_name from SCTRANS.V_USER_ORG_JOB VJ left join SCTRANS.ACT_HI_TASKINST AHT on aht.ASSIGNEE_=VJ.USERNAME where AHT.TASK_DEF_KEY_ ='Guohu' and t.INST_CODE=AHT.PROC_INST_ID_) GUOHU_REAL_NAME,
									(select top 1 vj.ORG_NAME from SCTRANS.V_USER_ORG_JOB VJ left join SCTRANS.ACT_HI_TASKINST AHT on aht.ASSIGNEE_=VJ.USERNAME where AHT.TASK_DEF_KEY_ ='Guohu' and t.INST_CODE=AHT.PROC_INST_ID_) GUOHU_ORG_NAME,
									case 		       	
										WHEN  T.SQUARE = 0		then  ROUND(CONVERT(float,s.REAL_PRICE)/CONVERT(float,1),2) 	
										ELSE  ROUND(CONVERT(float,s.REAL_PRICE)/ISNULL(CONVERT(float,T.SQUARE),1),2)
									END  GUOHUDJ,
									(select TOP 1 PM.dist_name from SCTRANS.T_TS_PR_RESEARCH_MAP PM WHERE T.DIST_CODE=PM.dist_code)AS dist_name	,
									
									CTM_CODE,
									(select TOP 1 M.CUST_NAME  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) CUST_NAME,
									(select TOP 1 GI.GUEST_PHONE from SCTRANS.T_TG_GUEST_INFO GI where GI.PKID IN (SELECT CUST_CODE FROM SCTRANS.T_TO_MORTGAGE M WHERE T.case_code=m.CASE_CODE)) AS GUEST_PHONE, /*主贷人电话*/
									PROPERTY_ADDR ,
									S.CON_PRICE, 
									(select TOP 1 TF.FIN_ORG_NAME FROM SCTRANS.T_TS_FIN_ORG TF WHERE TF.FIN_ORG_CODE=(select TOP 1 M.FIN_ORG_CODE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1)) FIN_ORG_NAME,  --银行
									(select TOP 1 TF.FIN_ORG_NAME_YC FROM SCTRANS.T_TS_FIN_ORG TF WHERE TF.FIN_ORG_CODE=(select TOP 1 M.FIN_ORG_CODE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1)) FIN_ORG_NAME_YC,  --支行
														
									LOAN_REQ,									
									AGENT_USERNAME,									
									T.PKID,								
									SQUARE,
									DIST_CODE,
									T.REAL_NAME , 
									T.ORG_NAME, 
									transferDate, 
									caseTransferDate , 
									status,
									GRP_NAME, 
									AR_NAME ,  
									wz.ORG_NAME AS VORG_NAME , 
									WZ.REAL_NAME AS VREAL_NAME,								

									(select TOP 1 M.COM_AMOUNT from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) COM_AMOUNT,
									(select TOP 1 M.PRF_AMOUNT from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) PRF_AMOUNT,
									(select TOP 1 M.COM_DISCOUNT from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) COM_DISCOUNT,
									(select TOP 1 M.COM_AMOUNT+m.PRF_AMOUNT as ACCOUNT from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) ACCOUNT,
									(select TOP 1 M.LOANER_NAME from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) LOANER_NAME,
									(select TOP 1 M.LOANER_PHONE from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) LOANER_PHONE,
									
									case 
									when (select TOP 1 M.IS_LOANER_ARRIVE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) =1 then '是' 
									when (select TOP 1 M.IS_LOANER_ARRIVE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) = 0 then '否' end   IS_LOANER_ARRIVE,
									
									case 
									when T.LOAN_REQ=1 and (select TOP 1 M.MORT_TYPE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) in('30016001','30016002') and (select TOP 1 M.IS_DELEGATE_YUCUI  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1)=1   then '收单' 
									when T.LOAN_REQ=1 and (select TOP 1 M.MORT_TYPE  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1) in('30016001','30016002') and (select TOP 1 M.IS_DELEGATE_YUCUI  from SCTRANS.T_TO_MORTGAGE M where T.case_code=m.CASE_CODE AND  M.IS_ACTIVE=1)=0   then '流失' 
									end   SDSTATUS  ,/*收单状态*/								
									(select TOP 1 REAL_NAME from SCTRANS.V_USER_ORG_JOB where USER_ID=ar.OPERATOR  AND ar.PART_CODE='GuohuApprove') AS ASSESSOR,
									ar.CONTENT,
									(select TOP 1 HT.REAL_HT_TIME FROM SCTRANS.T_TO_HOUSE_TRANSFER HT WHERE HT.CASE_CODE= T.CASE_CODE ) REAL_HT_TIME

							from (
									select c.pkid,c.case_code,c.CTM_CODE ,C.LOAN_REQ, p.PROPERTY_ADDR ,p.SQUARE,P.DIST_CODE, zg.REAL_NAME, zg.ORG_NAME, i.AR_NAME, i.GRP_CODE,I.GRP_NAME, I.AGENT_NAME,i.AGENT_USERNAME,w.INST_CODE,
									(SELECT TOP 1 tar.OPERATOR_TIME FROM sctrans.T_TO_APPROVE_RECORD tar WHERE tar.PART_CODE = 'Guohu' and tar.CASE_CODE = c.CASE_CODE ORDER BY tar.OPERATOR_TIME desc) transferDate,
									(SELECT TOP 1 tar.OPERATOR_TIME FROM sctrans.T_TO_APPROVE_RECORD tar WHERE tar.PART_CODE = 'GuohuApprove' and tar.CASE_CODE = c.CASE_CODE ORDER BY tar.OPERATOR_TIME desc) caseTransferDate, 
									v.long_ AS  status
									from sctrans.t_to_case c 
									inner join sctrans.T_TO_PROPERTY_INFO p on c.CASE_CODE = p.CASE_CODE 
									left join sctrans.V_USER_ORG_JOB zg on c.ORG_ID = zg.ORG_ID and zg.JOB_CODE ='manager'
									inner join sctrans.T_TO_CASE_info i on c.case_code = i.case_code
									inner join sctrans.T_TO_WORKFLOW w on c.case_code = w.case_code 
									and  w.BUSINESS_KEY = 'operation_process' and w.STATUS in (0, 4)
									inner join sctrans.act_hi_varinst v on v.PROC_INST_ID_ = w.INST_CODE AND v.name_='GuohuApprove') t 
									LEFT JOIN SCTRANS.SYS_ORG O ON T.GRP_CODE = O.ORG_CODE
									LEFT JOIN SCTRANS.T_SYS_ORG_HIERARCHY OH ON O.ID = OH.ORG_ID
									LEFT JOIN SCTRANS.V_USER_ORG_JOB WZ ON WZ.ORG_ID = OH.BUSIWZ_ID AND WZ.JOB_CODE = 'JQYDS' AND WZ.IS_LEADER = 1

									LEFT JOIN  ( select  * from  sctrans.T_TO_APPROVE_RECORD ar1  where  ar1.PART_CODE='GuohuApprove' and ar1.OPERATOR_TIME=(select max(ar2.OPERATOR_TIME) from sctrans.T_TO_APPROVE_RECORD ar2 where ar2.CASE_CODE = ar1.case_code)) ar ON ar.CASE_CODE=T.CASE_CODE
									INNER JOIN SCTRANS.T_TO_SIGN S ON T.CASE_CODE=S.CASE_CODE
								where 1=1
								 <ifNotNull caseTransferDateStart>
									AND caseTransferDate &gt; #caseTransferDateStart#
								</ifNotNull>
								<ifNotNull caseTransferDateEnd>
									AND  caseTransferDate &lt; #caseTransferDateEnd#
								</ifNotNull>					
								<ifNotNull transferDateStart>
									AND  transferDate &gt; #transferDateStart#
								</ifNotNull>
								<ifNotNull transferDateEnd>
									AND  transferDate &lt; #transferDateEnd#
								</ifNotNull>
								<ifNotNull caseCode>
									AND  CASE_CODE = #caseCode#
								</ifNotNull>					
								<ifNotNull orgName>
									AND T.ORG_NAME like '%' + #orgName# + '%' 
								</ifNotNull>
								<ifNotNull TransferStatus>
									AND  status = #TransferStatus#
								</ifNotNull>
								<ifNotNull vrealName>
									AND  VREAL_NAME like '%' + #vrealName# + '%' 
								</ifNotNull>
								<ifNotNull managerName>
									AND REAL_NAME like '%' + #managerName# + '%' 
								</ifNotNull>
								<ifNotNull propertyAddr>
									AND  PROPERTY_ADDR like '%' + #propertyAddr# + '%' 
								</ifNotNull>
				]]>
			</baseSql>
			<orderBySql>
				ORDER BY transferDate DESC,caseTransferDate DESC
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="BIGAREA" title="大区" customDict="" hidden="false" />					
				<column type="both" name="VREAL_NAME" title="区董" customDict=""
					hidden="false" />
				<column type="both" name="AGENT_ORG_NAME" title="分行"
					customDict="" hidden="false" />
				<column type="both" name="AGENT_NAME" title="业务员姓名"
					customDict="" hidden="false" />
				<column type="both" name="GUOHU_ORG_NAME" title="贵宾服务部"
					customDict="" hidden="false" />
				<column type="both" name="GUOHU_REAL_NAME" title="过户交易员"
					customDict="" hidden="false" />
				<column type="both" name="GUOHUDJ" title="过户单价" customDict=""
					hidden="false" />
				<column type="both" name="dist_name" title="过户区域" customDict=""
					hidden="false" />
				<column type="both" name="REAL_HT_TIME" title="实际过户时间"
					customDict="" beanFormatter="newDateFormatter" expType="date" expFmt="yyyy-MM-dd"
					hidden="false" />
				<column type="both" name="CTM_CODE" title="CTM编号" customDict=""
					hidden="false" />
				<column type="both" name="CUST_NAME" title="主贷人姓名"
					customDict="" hidden="false" />
				<column type="both" name="GUEST_PHONE" title="主贷人电话"
					customDict="" hidden="false" />
				<column type="both" name="PROPERTY_ADDR" title="产权地址"
					customDict="" hidden="false" />
				<column type="both" name="CON_PRICE" title="合同价" customDict=""
					hidden="false" />
				<column type="both" name="FIN_ORG_NAME" title="银行"
					customDict="" hidden="false" />
				<column type="both" name="FIN_ORG_NAME_YC" title="支行"
					customDict="" hidden="false" />
				<column type="both" name="COM_AMOUNT" title="商贷金额"
					customDict="" hidden="false" />
				<column type="both" name="PRF_AMOUNT" title="公积金金额"
					customDict="" hidden="false" />
				<column type="both" name="ACCOUNT" title="贷款总额" customDict=""
					hidden="false" />
				<column type="both" name="COM_DISCOUNT" title="贷款利率"
					customDict="" hidden="false" />
				<column type="both" name="CASE_CODE" title="誉萃编号" customDict=""
					hidden="false" />
				<column type="both" name="LOANER_NAME" title="货代专员"
					customDict="" hidden="false" />
				<column type="both" name="LOANER_PHONE" title="专员电话"
					customDict="" hidden="false" />
				<column type="both" name="SDSTATUS" title="收单状况" customDict=""
					hidden="false" />
				<column type="both" name="IS_LOANER_ARRIVE" title="是否到场"
					customDict="" hidden="false" />
				<column type="virtual" name="SELLER" title="上家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="上家"
					customDict="qqcdSeller" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="SELLER_MOBILE" title="上家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="上家电话"
					customDict="qqcdSellerPhone" sysDict="" format="" width="60"
					isSort="true" align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER" title="下家姓名"
					referencecol="CASE_CODE" index="" checkbox="" display="下家"
					customDict="qqcdBuyer" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="virtual" name="BUYER_MOBILE" title="下家电话"
					referencecol="CASE_CODE" index="" checkbox="" display="下家电话"
					customDict="qqcdBuyerPhone" sysDict="" format="" width="60" isSort="true"
					align="" halign="" order="" resizable="" />
				<column type="both" name="transferDate" title="过户提交时间"
					customDict="" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" hidden="false" />
				<column type="both" name="caseTransferDate" title="过户审批时间"
					customDict="" hidden="false" beanFormatter="dateFormatter" expType="date"
					expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="ASSESSOR" title="审核人" customDict=""
					hidden="false" />
				<column type="both" name="status" title="是否审批通过" customDict=""
					hidden="false" />
				<column type="virtual" name="status1" title="是否审批通过"
					referencecol="status" customDict="convertValue" />
				<column type="both" name="CONTENT" title="审核结果" customDict=""
					hidden="false" />
				<column type="both" name="PKID" index="" checkbox="" display="案件ID"
					customDict="" sysDict="" format="" width="90" isSort="" align=""
					halign="" order="" resizable="" />
				<column type="both" name="REAL_NAME" title="主管"
					customDict="" hidden="false" />
				<column type="both" name="ORG_NAME" title="主管组别"
					customDict="" hidden="false" />
				<column type="both" name="GRP_NAME" title="店组"
					customDict="" hidden="false" />
				<column type="both" name="AR_NAME" title="片区"
					customDict="" hidden="false" />
				<column type="both" name="VORG_NAME" title="区域" customDict=""
					hidden="false" />
			</table-row>
		</grid>
	</query>
</querys>
