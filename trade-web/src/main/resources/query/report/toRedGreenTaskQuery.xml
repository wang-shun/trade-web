<?xml version="1.0" encoding="UTF-8"?>
<querys>
	<dicts>
		<customDict id="convertValue" beanName="convertValue"></customDict>
		<customDict id="convertColor" beanName="convertColor"></customDict>
	</dicts>
	<formatters>
		<formatter id="dateFormatter" ref=""
			class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd HH:mm:ss</property>
			</properties>
		</formatter>
		<formatter id="dateFormattertoDate" ref=""
			class="com.aist.common.quickQuery.formatter.DateFormatter">
			<properties>
				<property name="pattern">yyyy-MM-dd</property>
			</properties>
		</formatter>
		<formatter id="numberFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="groupingUsed">true</property>
				<property name="maximumFractionDigits">3</property>
				<property name="maximumIntegerDigits">40</property>
				<property name="minimumFractionDigits">0</property>
				<property name="minimumIntegerDigits">1</property>
			</properties>
		</formatter>
		<formatter id="integerFormater" ref=""
			class="com.aist.common.quickQuery.formatter.NumberFormatter">
			<properties>
				<property name="maximumFractionDigits">0</property>
			</properties>
		</formatter>
		<formatter id="emailFormater" ref=""
			class="com.aist.common.quickQuery.formatter.EmailFormatter" />
	</formatters>
	<query id="queryRedGreenTaskCountList" cacheCount="true">
		<searchCondition>
		
		    
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
					SELECT
	t1.orgName1,
	t1.realName1,
	t1.orgName2,
	t1.realName2,
	ISNULL(t2.count1, 0) AS yellow,
	ISNULL(t3.count1, 0) AS red,
	GETDATE() AS importtime,
	t1.id
FROM
	(
		SELECT
			org1.id id,
			uoj1.ORG_NAME orgName1,
			uoj1.REAL_NAME realName1,
			uoj.ORG_NAME orgName2,
			uoj.REAL_NAME AS realName2
		FROM
			
				sctrans.sys_org org1
		RIGHT JOIN sctrans.V_USER_ORG_JOB uoj ON org1.ID = uoj.ORG_ID AND uoj.JOB_CODE = 'Manager'
		--RIGHT JOIN sctrans.SYS_JOB j ON j.ID = uoj.JOB_ID AND j.JOB_CODE = 'Manager'
		--LEFT JOIN sctrans.SYS_USER u1 ON u1.id = uoj.USER_ID
		left JOIN sctrans.V_USER_ORG_JOB uoj1 ON org1.PARENT_ID = uoj1.ORG_ID AND uoj1.JOB_CODE = 'director'
		--RIGHT JOIN sctrans.SYS_JOB j1 ON j1.id = uoj1.JOB_ID AND j1.JOB_CODE = 'director'
		--LEFT JOIN sctrans.SYS_USER u2 ON u2.id = uoj1.USER_ID
		--LEFT JOIN sctrans.SYS_ORG org2 ON org2.ID = uoj1.ORG_ID
		WHERE
			org1.PARENT_ID IN (
				'FF5BC56E0E4B45289DAA5721A494C7C5',
				'8a8493d453141f3301532c9568011af9',
				'd5878adf8b0c4032aeae895c701ed693',
				'de81a98a8ec341caa8e9bc77c46cd370',
				'54b3233fdf994d9987e7c8febc223588',
				'960089538bc54a9a9139ef52ceb45b33',
				'6114AB949B4445828D4383977C4FAC71',
				'6a84979158b942b78a8a5921cc30b8c3'
			)
	) t1
  LEFT join(select id as orgId,color,count(*) as count1 from (
					  SELECT
				MIN (l.color) AS color,
				t.CASE_CODE AS caseCode,
				t.PART_CODE AS taskName,
				tp.PROPERTY_ADDR AS propertyAddress,
				uoj.REAL_NAME AS realName,
				t.EST_PART_TIME AS estPartTime,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id id
			FROM
				[sctrans].[T_TO_TRANS_PLAN] AS t
			LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
			LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
			LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE AND w.INST_CODE = ta.[PROC_INST_ID_] AND ta.suspension_state_ = '1'
			LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
			--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
			LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
			--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
			WHERE
				uoj.org_id IS NOT NULL
			GROUP BY
				t.CASE_CODE,
				t.PART_CODE,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id
		) AS a where color &lt;&gt; '2' group by id,color)  t2 on t1.id=t2.orgId and t2.color=0
							  
 left join(select id as orgId,color,count(*) as count1 from (
					  SELECT
				MIN (l.color) AS color,
				t.CASE_CODE AS caseCode,
				t.PART_CODE AS taskName,
				tp.PROPERTY_ADDR AS propertyAddress,
				uoj.REAL_NAME AS realName,
				t.EST_PART_TIME AS estPartTime,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id id
			FROM
				[sctrans].[T_TO_TRANS_PLAN] AS t
			LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
			LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
			LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE
			AND w.INST_CODE = ta.[PROC_INST_ID_]
			AND ta.suspension_state_ = '1'
			LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
			--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
			LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
			--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
			WHERE
				uoj.org_id IS NOT NULL
			GROUP BY
				t.CASE_CODE,
				t.PART_CODE,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id
		) AS a where color &lt;&gt; '2' group by id,color)
							  t3 on t1.id=t3.orgId and t3.color=1
							  where 1=1 
							   <ifNotNull proOrggbName>
										   and t1.orgName1 =#proOrggbName#
							  </ifNotNull>
							  
							  <ifNotNull TextValName>
										   and t1.realName2 =#TextValName#
							  </ifNotNull>
							  
							  <ifNotNull TextValNameZj>
										   and t1.realName1 =#TextValNameZj#
							  </ifNotNull>
							  
							  <ifNotNull proOrgName>
										   and t1.orgName2 =#proOrgName#
							  </ifNotNull>
							  
				]]>
			</baseSql>
			<orderBySql>
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="orgName1" index="" checkbox="" display="贵宾服务部" customDict=""  />
				<column type="both" name="realName1" index="" checkbox="" display="总监" customDict=""  />
				<column type="both" name="orgName2" index="" checkbox="" display="组别" customDict="" />
				<column type="both" name="realName2" index="" checkbox="" display="主管" customDict=""  />
				<column type="both" name="yellow" index="" checkbox="" display="黄灯" customDict=""  />
				<column type="both" name="red" index="" checkbox="" display="红灯" customDict=""  />
				<column type="both" name="importtime" index="" checkbox="" display="导出时间" customDict=""   beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="id" index="" checkbox="" display="" customDict=""  />
			</table-row>
		</grid>
	</query>
	<!-- 红绿灯任务统计 贵宾服务部汇总 -->
	<query id="queryRedGreenTaskCountGbList" cacheCount="true">
		<searchCondition>
		
		    
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
				

select case when grouping(k.orgName1)=1 then '合计' else k.orgName1 end as orgName1,

   case when grouping(k.realName1)=1 and grouping(k.orgName1)=0 then '小计' else k.realName1 end realName1,


sum(k.red) yellowall,sum(k.yellow) as redall from (

					select t1.orgName1,t1.realName1,t1.orgName2,t1.realName2,ISNULL(t2.count1,0) as yellow, ISNULL(t3.count1,0) as red ,GETDATE()  as importtime,t1.id from (
SELECT
					org1.id id,
					uoj1.ORG_NAME orgName1,
					uoj1.REAL_NAME realName1,
					org1.ORG_NAME orgName2,
					uoj.REAL_NAME AS realName2
				FROM
					sctrans.sys_org org1
				RIGHT JOIN sctrans.V_USER_ORG_JOB uoj ON org1.ID = uoj.ORG_ID  AND uoj.JOB_CODE = 'Manager'
				--RIGHT JOIN sctrans.SYS_JOB j ON j.ID = uoj.JOB_ID
				--AND j.JOB_CODE = 'Manager'
				--LEFT JOIN sctrans.SYS_USER u1 ON u1.id = uoj.USER_ID
				LEFT JOIN sctrans.V_USER_ORG_JOB uoj1 ON org1.PARENT_ID = uoj1.ORG_ID AND uoj1.JOB_CODE = 'director'
				--RIGHT JOIN sctrans.SYS_JOB j1 ON j1.id = uoj1.JOB_ID
				--AND j1.JOB_CODE = 'director'
				--LEFT JOIN sctrans.SYS_USER u2 ON u2.id = uoj1.USER_ID
				--LEFT JOIN sctrans.SYS_ORG org2 ON org2.ID = uoj1.ORG_ID
				WHERE
					org1.PARENT_ID IN (
						'FF5BC56E0E4B45289DAA5721A494C7C5',
						'8a8493d453141f3301532c9568011af9',
						'd5878adf8b0c4032aeae895c701ed693',
						'de81a98a8ec341caa8e9bc77c46cd370',
						'54b3233fdf994d9987e7c8febc223588',
						'960089538bc54a9a9139ef52ceb45b33',
						'6114AB949B4445828D4383977C4FAC71',
						'6a84979158b942b78a8a5921cc30b8c3'
					) ) t1 
  LEFT join(select id as orgId,color,count(*) as count1 from (
					  SELECT
						MIN (l.color) AS color,
						t.CASE_CODE AS caseCode,
						t.PART_CODE AS taskName,
						tp.PROPERTY_ADDR AS propertyAddress,
						uoj.REAL_NAME AS realName,
						t.EST_PART_TIME AS estPartTime,
						ta.ID_,
						ta.PROC_INST_ID_,
						uoj.org_id id
					FROM
						[sctrans].[T_TO_TRANS_PLAN] AS t
					LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
					LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
					LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE
					AND w.INST_CODE = ta.[PROC_INST_ID_]
					AND ta.suspension_state_ = '1'
					LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
					--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
					LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
					--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
					WHERE
						uoj.org_id IS NOT NULL
					GROUP BY
						t.CASE_CODE,
						t.PART_CODE,
						tp.PROPERTY_ADDR,
						uoj.REAL_NAME,
						t.EST_PART_TIME,
						ta.ID_,
						ta.PROC_INST_ID_,
						uoj.org_id
							  )as a where color &lt;&gt; '2' group by id,color)  t2 on t1.id=t2.orgId and t2.color=0
							  
 left join(select id as orgId,color,count(*) as count1 from (
					  SELECT
						MIN (l.color) AS color,
						t.CASE_CODE AS caseCode,
						t.PART_CODE AS taskName,
						tp.PROPERTY_ADDR AS propertyAddress,
						uoj.REAL_NAME AS realName,
						t.EST_PART_TIME AS estPartTime,
						ta.ID_,
						ta.PROC_INST_ID_,
						uoj.org_id id
					FROM
						[sctrans].[T_TO_TRANS_PLAN] AS t
					LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
					LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
					LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE
					AND w.INST_CODE = ta.[PROC_INST_ID_]
					AND ta.suspension_state_ = '1'
					LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
					--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
					LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
					--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
					WHERE
						uoj.org_id IS NOT NULL
					GROUP BY
						t.CASE_CODE,
						t.PART_CODE,
						tp.PROPERTY_ADDR,
						uoj.REAL_NAME,
						t.EST_PART_TIME,
						ta.ID_,
						ta.PROC_INST_ID_,
						uoj.org_id
							  )as a where color &lt;&gt; '2' group by id,color)
							  t3 on t1.id=t3.orgId and t3.color=1
							  where 1=1 
							   <ifNotNull proOrggbName>
										   and t1.orgName1 =#proOrggbName#
							  </ifNotNull>
							  
							  <ifNotNull TextValName>
										   and t1.realName2 =#TextValName#
							  </ifNotNull>
							  
							  <ifNotNull TextValNameZj>
										   and t1.realName1 =#TextValNameZj#
							  </ifNotNull>
							  
							  <ifNotNull proOrgName>
										   and t1.orgName2 =#proOrgName#
							  </ifNotNull>
							  
							  
							   ) k group by k.orgName1,k.realName1 
							  
				]]>
			</baseSql>
			
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="orgName1" index="" checkbox="" display="贵宾服务部" customDict=""  />
				<column type="both" name="realName1" index="" checkbox="" display="总监" customDict=""  />
				<column type="both" name="yellowall" index="" checkbox="" display="黄灯" customDict=""  />
				<column type="both" name="redall" index="" checkbox="" display="红灯" customDict=""  />
				<column type="both" name="importtime" index="" checkbox="" display="导出时间" customDict=""   beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="id" index="" checkbox="" display="" customDict=""  />
			</table-row>
		</grid>
	</query>
	
	<query id="queryRedGreenTaskCountExcelList" cacheCount="true">
		<searchCondition>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
					select t1.orgName1,t1.realName1,t1.orgName2,t1.realName2,ISNULL(t2.count1,0) as yellow, ISNULL(t3.count1,0) as red ,ISNULL(t2.count1,0)+ISNULL(t3.count1,0) as allcolor ,GETDATE()  as importtime,t1.id from (
select org1.id id,org2.ORG_NAME orgName1,u2.REAL_NAME  realName1,org1.ORG_NAME orgName2  ,u1.REAL_NAME as realName2 from sctrans.sys_org org1
left join sctrans.V_USER_ORG_JOB uoj
on org1.ID=uoj.ORG_ID
right join sctrans.SYS_JOB j
on j.ID=uoj.JOB_ID and j.JOB_CODE='Manager'
left join sctrans.SYS_USER u1 on u1.id=uoj.USER_ID
left join sctrans.V_USER_ORG_JOB uoj1
on org1.PARENT_ID=uoj1.ORG_ID
right join sctrans.SYS_JOB j1
on j1.id=uoj1.JOB_ID and j1.JOB_CODE='director'
left join sctrans.SYS_USER u2 on u2.id=uoj1.USER_ID
left join sctrans.SYS_ORG org2 
on org2.ID=uoj1.ORG_ID 

 where org1.PARENT_ID in ('FF5BC56E0E4B45289DAA5721A494C7C5',
'8a8493d453141f3301532c9568011af9',
'd5878adf8b0c4032aeae895c701ed693',
'de81a98a8ec341caa8e9bc77c46cd370',
'54b3233fdf994d9987e7c8febc223588',
'960089538bc54a9a9139ef52ceb45b33',
'6114AB949B4445828D4383977C4FAC71',
'6a84979158b942b78a8a5921cc30b8c3') ) t1 
  LEFT join(select id as orgId,color,count(*) as count1 from (
					  SELECT min(l.color) as color,t.CASE_CODE as caseCode,t.PART_CODE as taskName,tp.PROPERTY_ADDR as propertyAddress,u.REAL_NAME as realName
					  	  ,t.EST_PART_TIME as estPartTime,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
							 FROM [sctrans].[T_TO_TRANS_PLAN] as t 
							 left join sctrans.T_TO_PROPERTY_INFO as tp
							 on t.case_code=tp.case_code
							  left join sctrans.t_to_workflow as w
							  on w.case_code=t.CASE_CODE 
							   left join sctrans.act_ru_task ta
							  on ta.[TASK_DEF_KEY_]=t.PART_CODE and w.INST_CODE=ta.[PROC_INST_ID_]and ta.suspension_state_='1'
							  left join sctrans.LAMP_RULE l
							  on GETDATE()-t.EST_PART_TIME>=l.DELAYTIME
							  left join sctrans.SYS_USER as u 
							  on ta.ASSIGNEE_=u.USERNAME
							  left join sctrans.V_USER_ORG_JOB as uoj
							  on uoj.[USER_ID]=u.ID
							  left join sctrans.SYS_ORG as sysOrg
							  on sysOrg.ID=uoj.org_id
							  where u.id is not null
							  	  
							  group by t.CASE_CODE,t.PART_CODE,tp.PROPERTY_ADDR ,u.REAL_NAME,t.EST_PART_TIME,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
						
							  
							  )as a where color &lt;&gt; '2' group by id,color)  t2 on t1.id=t2.orgId and t2.color=0
							  
 left join(select id as orgId,color,count(*) as count1 from (
					  SELECT min(l.color) as color,t.CASE_CODE as caseCode,t.PART_CODE as taskName,tp.PROPERTY_ADDR as propertyAddress,u.REAL_NAME as realName
					  	  ,t.EST_PART_TIME as estPartTime,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
							 FROM [sctrans].[T_TO_TRANS_PLAN] as t 
							 left join sctrans.T_TO_PROPERTY_INFO as tp
							 on t.case_code=tp.case_code
							  left join sctrans.t_to_workflow as w
							  on w.case_code=t.CASE_CODE 
							   left join sctrans.act_ru_task ta
							  on ta.[TASK_DEF_KEY_]=t.PART_CODE and w.INST_CODE=ta.[PROC_INST_ID_] and ta.suspension_state_='1'
							  left join sctrans.LAMP_RULE l
							  on GETDATE()-t.EST_PART_TIME>=l.DELAYTIME
							  left join sctrans.SYS_USER as u 
							  on ta.ASSIGNEE_=u.USERNAME
							  left join sctrans.V_USER_ORG_JOB as uoj
							  on uoj.[USER_ID]=u.ID
							  left join sctrans.SYS_ORG as sysOrg
							  on sysOrg.ID=uoj.org_id
							  where u.id is not null
							  	  
							  group by t.CASE_CODE,t.PART_CODE,tp.PROPERTY_ADDR ,u.REAL_NAME,t.EST_PART_TIME,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
						
							  
							  )as a where color &lt;&gt; '2' group by id,color)
							  t3 on t1.id=t3.orgId and t3.color=1
							   where 1=1 
							   <ifNotNull proOrggbName>
										   and t1.orgName1 =#proOrggbName#
							  </ifNotNull>
							  
							  <ifNotNull TextValName>
										   and t1.realName2 =#TextValName#
							  </ifNotNull>
							  
							  <ifNotNull TextValNameZj>
										   and t1.realName1 =#TextValNameZj#
							  </ifNotNull>
							  
							  <ifNotNull proOrgName>
										   and t1.orgName2 =#proOrgName#
							  </ifNotNull>
				]]>
			</baseSql>
			<orderBySql>
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="orgName1"  title="贵宾服务部" customDict=""  hidden="false" />
				<column type="both" name="realName1"  title="总监" customDict=""  hidden="false" />
				<column type="both" name="orgName2"  title="组别" customDict=""  hidden="false"/>
				<column type="both" name="realName2"  title="主管" customDict=""  hidden="false" />
				<column type="both" name="red"  title="黄灯" customDict=""  hidden="false" expType="Integer" />
				<column type="both" name="yellow"  title="红灯" customDict=""  hidden="false"  expType="Integer"/>
				<column type="both" name="allcolor"  title="合计" customDict=""  hidden="false"  expType="Integer"/>
				<column type="both" name="importtime"  title="导出时间" customDict=""  hidden="false"  beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="id"  title="" customDict=""  hidden="false"/>
			</table-row>
		</grid>
	</query>
	<query id="queryRedGreenTaskCountExcelGbList" cacheCount="true">
		<searchCondition>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
				
				select case when grouping(k.orgName1)=1 then '合计' else k.orgName1 end as orgName1,

   case when grouping(k.realName1)=1 and grouping(k.orgName1)=0 then '小计' else k.realName1 end realName1,


sum(k.red) yellowall,sum(k.yellow) as redall ,sum(k.red)+sum(k.yellow) as allcolor,GETDATE()  as importtime from (
					select t1.orgName1,t1.realName1,t1.orgName2,t1.realName2,ISNULL(t2.count1,0) as yellow, ISNULL(t3.count1,0) as red ,GETDATE()  as importtime,t1.id from (
select org1.id id,org2.ORG_NAME orgName1,u2.REAL_NAME  realName1,org1.ORG_NAME orgName2  ,u1.REAL_NAME as realName2 from sctrans.sys_org org1
left join sctrans.V_USER_ORG_JOB uoj
on org1.ID=uoj.ORG_ID
right join sctrans.SYS_JOB j
on j.ID=uoj.JOB_ID and j.JOB_CODE='Manager'
left join sctrans.SYS_USER u1 on u1.id=uoj.USER_ID
left join sctrans.V_USER_ORG_JOB uoj1
on org1.PARENT_ID=uoj1.ORG_ID
right join sctrans.SYS_JOB j1
on j1.id=uoj1.JOB_ID and j1.JOB_CODE='director'
left join sctrans.SYS_USER u2 on u2.id=uoj1.USER_ID
left join sctrans.SYS_ORG org2 
on org2.ID=uoj1.ORG_ID 

 where org1.PARENT_ID in ('FF5BC56E0E4B45289DAA5721A494C7C5',
'8a8493d453141f3301532c9568011af9',
'd5878adf8b0c4032aeae895c701ed693',
'de81a98a8ec341caa8e9bc77c46cd370',
'54b3233fdf994d9987e7c8febc223588',
'960089538bc54a9a9139ef52ceb45b33',
'6114AB949B4445828D4383977C4FAC71',
'6a84979158b942b78a8a5921cc30b8c3') ) t1 
  LEFT join(select id as orgId,color,count(*) as count1 from (
					  SELECT min(l.color) as color,t.CASE_CODE as caseCode,t.PART_CODE as taskName,tp.PROPERTY_ADDR as propertyAddress,u.REAL_NAME as realName
					  	  ,t.EST_PART_TIME as estPartTime,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
							 FROM [sctrans].[T_TO_TRANS_PLAN] as t 
							 left join sctrans.T_TO_PROPERTY_INFO as tp
							 on t.case_code=tp.case_code
							  left join sctrans.t_to_workflow as w
							  on w.case_code=t.CASE_CODE 
							   left join sctrans.act_ru_task ta
							  on ta.[TASK_DEF_KEY_]=t.PART_CODE and w.INST_CODE=ta.[PROC_INST_ID_]and ta.suspension_state_='1'
							  left join sctrans.LAMP_RULE l
							  on GETDATE()-t.EST_PART_TIME>=l.DELAYTIME
							  left join sctrans.SYS_USER as u 
							  on ta.ASSIGNEE_=u.USERNAME
							  left join sctrans.V_USER_ORG_JOB as uoj
							  on uoj.[USER_ID]=u.ID
							  left join sctrans.SYS_ORG as sysOrg
							  on sysOrg.ID=uoj.org_id
							  where u.id is not null
							  	  
							  group by t.CASE_CODE,t.PART_CODE,tp.PROPERTY_ADDR ,u.REAL_NAME,t.EST_PART_TIME,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
						
							  
							  )as a where color &lt;&gt; '2' group by id,color)  t2 on t1.id=t2.orgId and t2.color=0
							  
 left join(select id as orgId,color,count(*) as count1 from (
					  SELECT min(l.color) as color,t.CASE_CODE as caseCode,t.PART_CODE as taskName,tp.PROPERTY_ADDR as propertyAddress,u.REAL_NAME as realName
					  	  ,t.EST_PART_TIME as estPartTime,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
							 FROM [sctrans].[T_TO_TRANS_PLAN] as t 
							 left join sctrans.T_TO_PROPERTY_INFO as tp
							 on t.case_code=tp.case_code
							  left join sctrans.t_to_workflow as w
							  on w.case_code=t.CASE_CODE 
							   left join sctrans.act_ru_task ta
							  on ta.[TASK_DEF_KEY_]=t.PART_CODE and w.INST_CODE=ta.[PROC_INST_ID_] and ta.suspension_state_='1'
							  left join sctrans.LAMP_RULE l
							  on GETDATE()-t.EST_PART_TIME>=l.DELAYTIME
							  left join sctrans.SYS_USER as u 
							  on ta.ASSIGNEE_=u.USERNAME
							  left join sctrans.V_USER_ORG_JOB as uoj
							  on uoj.[USER_ID]=u.ID
							  left join sctrans.SYS_ORG as sysOrg
							  on sysOrg.ID=uoj.org_id
							  where u.id is not null
							  	  
							  group by t.CASE_CODE,t.PART_CODE,tp.PROPERTY_ADDR ,u.REAL_NAME,t.EST_PART_TIME,ta.ID_,ta.PROC_INST_ID_,sysOrg.id
						
							  
							  )as a where color &lt;&gt; '2' group by id,color)
							  t3 on t1.id=t3.orgId and t3.color=1
							   where 1=1 
							   <ifNotNull proOrggbName>
										   and t1.orgName1 =#proOrggbName#
							  </ifNotNull>
							  
							  <ifNotNull TextValName>
										   and t1.realName2 =#TextValName#
							  </ifNotNull>
							  
							  <ifNotNull TextValNameZj>
										   and t1.realName1 =#TextValNameZj#
							  </ifNotNull>
							  
							  <ifNotNull proOrgName>
										   and t1.orgName2 =#proOrgName#
							  </ifNotNull>
							  
							  
							   ) k group by k.orgName1,k.realName1 
							  
							  
				]]>
			</baseSql>
			<orderBySql>
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
				<column type="both" name="orgName1"  title="贵宾服务部" customDict=""  hidden="false" />
				<column type="both" name="realName1"  title="总监" customDict=""  hidden="false" />
				<column type="both" name="orgName2"  title="组别" customDict=""  hidden="false"/>
				<column type="both" name="realName2"  title="主管" customDict=""  hidden="false" />
				<column type="both" name="yellowall"  title="黄灯" customDict=""  hidden="false"/>
				<column type="both" name="redall"  title="红灯" customDict=""  hidden="false"/>
				<column type="both" name="allcolor"  title="合计" customDict=""  hidden="false"/>
				<column type="both" name="importtime"  title="导出时间" customDict=""  hidden="false"  beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" />
				<column type="both" name="id"  title="" customDict=""  hidden="false"/>
			</table-row>
		</grid>
	</query>
	
	<query id="queryRedGreenTaskDetailList" cacheCount="true">
		<searchCondition>
            <condition field="t2.PROPERTY_ADDR" name="propertyAddr" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
            <condition field="t2.REAL_NAME" name="realName" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
            <condition field="t2.CASE_CODE" name="caseCode" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
            <condition field="t2.PART_CODE" name="taskDfKey" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
					SELECT t1.orgName1,t1.realName1,t1.orgName2,t1.realName2,t2.*,GETDATE()  as IMPORTTIME from (
        SELECT
			org1.id id,
			uoj1.ORG_NAME orgName1,
			uoj1.REAL_NAME realName1,
			org1.ORG_NAME orgName2,
			uoj.REAL_NAME AS realName2
		FROM
			sctrans.sys_org org1
		RIGHT JOIN sctrans.V_USER_ORG_JOB uoj ON org1.ID = uoj.ORG_ID AND uoj.JOB_CODE = 'Manager'
		--RIGHT JOIN sctrans.SYS_JOB j ON j.ID = uoj.JOB_ID
		--AND j.JOB_CODE = 'Manager'
		--LEFT JOIN sctrans.SYS_USER u1 ON u1.id = uoj.USER_ID
		LEFT JOIN sctrans.V_USER_ORG_JOB uoj1 ON org1.PARENT_ID = uoj1.ORG_ID AND uoj1.JOB_CODE = 'director'
		--RIGHT JOIN sctrans.SYS_JOB j1 ON j1.id = uoj1.JOB_ID
		--AND j1.JOB_CODE = 'director'
		--LEFT JOIN sctrans.SYS_USER u2 ON u2.id = uoj1.USER_ID
		--LEFT JOIN sctrans.SYS_ORG org2 ON org2.ID = uoj1.ORG_ID
		WHERE
			org1.PARENT_ID IN (
				'FF5BC56E0E4B45289DAA5721A494C7C5',
				'8a8493d453141f3301532c9568011af9',
				'd5878adf8b0c4032aeae895c701ed693',
				'de81a98a8ec341caa8e9bc77c46cd370',
				'54b3233fdf994d9987e7c8febc223588',
				'960089538bc54a9a9139ef52ceb45b33',
				'6114AB949B4445828D4383977C4FAC71',
				'6a84979158b942b78a8a5921cc30b8c3'
			) )
t1 inner join(select * from (
        SELECT
				MIN (l.color) AS color,
				t.CASE_CODE,
				k.PKID,
				(
					SELECT
						name
					FROM
						sctrans.sys_dict
					WHERE
						type = 'part_code'
					AND code = t.PART_CODE
				) TASKNAME,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				uoj.org_id orgid,
				T.PART_CODE
			FROM
				[sctrans].[T_TO_TRANS_PLAN] AS t
			LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
			LEFT JOIN sctrans.t_to_case AS k ON t.CASE_CODE = k.CASE_CODE
			LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
			LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE
			AND w.INST_CODE = ta.[PROC_INST_ID_]
			AND ta.suspension_state_ = '1'
			LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
			--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
			LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
			--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
			WHERE
				uoj.org_id IS NOT NULL
			AND l.color != '2'
			GROUP BY
				t.CASE_CODE,
				k.PKID,
				t.PART_CODE,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id
                  )as a ) t2 on t1.id=t2.orgId 
                  
                  <ifNotNull organId>
							   where t1.id = #organId#
				  </ifNotNull>
				  <ifNotNull colourId>
							   and t2.color =#colourId#
				  </ifNotNull>
				  <ifNotNull dtBegin>
							   and t2.EST_PART_TIME >=#dtBegin#
				  </ifNotNull>
				  <ifNotNull dtEnd>
							   and t2.EST_PART_TIME &lt;=#dtEnd#
				  </ifNotNull>
				  <ifNotNull lampRadios>
							   and t2.color =#lampRadios#
				  </ifNotNull>
				  
				  <ifNotNull proOrggbName>
							   and t1.orgName1 =#proOrggbName#
				  </ifNotNull>
				  
				  <ifNotNull proOrgName>
							   and t1.orgName2 =#proOrgName#
				  </ifNotNull>
				  
    
				  
				 
				]]>
			</baseSql>
			<orderBySql>
					order by t2.EST_PART_TIME desc
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
			
				<column type="both" name="orgName1"  display="贵宾服务部" customDict=""  />
				<column type="both" name="realName1"  display="总监" customDict="" />
				<column type="both" name="orgName2"  display="组别" customDict=""  />
				<column type="both" name="realName2" display="主管" customDict=""  />
				
				<column type="both" name="color" display="红黄灯" customDict="" />
				<column type="virtual" name="color1" display="红黄灯" referencecol="color"  customDict="convertColor"/>
				<column type="both" name="CASE_CODE"  display="案件编号" customDict="" isSort="true" />
				<column type="both" name="PKID"  display="案件ID" customDict=""  />
				<column type="both" name="TASKNAME"  display="任务名" customDict=""  />
				<column type="both" name="PROPERTY_ADDR"  display="产证地址" customDict="" />
				<column type="both" name="REAL_NAME"  display="经办人" customDict="" />
				<column type="both" name="EST_PART_TIME"  display="预计完成时间" customDict="" beanFormatter="dateFormattertoDate" expType="date" expFmt="yyyy-MM-dd" isSort="true" />
				
				
				<column type="both" name="PROPERTY_ADDR"  display="产证地址" customDict=""  />
				<column type="both" name="IMPORTTIME" display="导出时间" customDict=""  beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss"/>
			</table-row>
		</grid>
	</query>
	
	<query id="queryRedGreenTaskExcelItemList" cacheCount="true">
		<searchCondition>
		    <condition field="t2.PROPERTY_ADDR" name="propertyAddr" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
            <condition field="t2.REAL_NAME" name="realName" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
            <condition field="t2.CASE_CODE" name="caseCode" searchType="LIKE" showType="" showCallback="" defaultValue=""/>
          <!--   <condition field="t2.PART_CODE" name="taskDfKey" searchType="LIKE" showType="" showCallback="" defaultValue=""/> -->
		</searchCondition>
		<searchSql>
			<baseSql>
				<![CDATA[
					SELECT t1.orgName1,t1.realName1,t1.orgName2,t1.realName2,t2.EST_PART_TIME,t2.*,GETDATE()  as IMPORTTIME from (
        SELECT
			org1.id id,
			uoj1.ORG_NAME orgName1,
			uoj1.REAL_NAME realName1,
			org1.ORG_NAME orgName2,
			uoj.REAL_NAME AS realName2
		FROM
			sctrans.sys_org org1
		RIGHT JOIN sctrans.V_USER_ORG_JOB uoj ON org1.ID = uoj.ORG_ID AND uoj.JOB_CODE = 'Manager'
		--RIGHT JOIN sctrans.SYS_JOB j ON j.ID = uoj.JOB_ID
		--AND j.JOB_CODE = 'Manager'
		--LEFT JOIN sctrans.SYS_USER u1 ON u1.id = uoj.USER_ID
		LEFT JOIN sctrans.V_USER_ORG_JOB uoj1 ON org1.PARENT_ID = uoj1.ORG_ID AND uoj1.JOB_CODE = 'director'
		--RIGHT JOIN sctrans.SYS_JOB j1 ON j1.id = uoj1.JOB_ID
		--AND j1.JOB_CODE = 'director'
		--LEFT JOIN sctrans.SYS_USER u2 ON u2.id = uoj1.USER_ID
		--LEFT JOIN sctrans.SYS_ORG org2 ON org2.ID = uoj1.ORG_ID
		WHERE
			org1.PARENT_ID IN (
				'FF5BC56E0E4B45289DAA5721A494C7C5',
				'8a8493d453141f3301532c9568011af9',
				'd5878adf8b0c4032aeae895c701ed693',
				'de81a98a8ec341caa8e9bc77c46cd370',
				'54b3233fdf994d9987e7c8febc223588',
				'960089538bc54a9a9139ef52ceb45b33',
				'6114AB949B4445828D4383977C4FAC71',
				'6a84979158b942b78a8a5921cc30b8c3'
			)  )
t1 inner join(select * from (
        SELECT
				MIN (l.color) AS color,
				t.CASE_CODE,
				k.PKID,
				(
					SELECT
						name
					FROM
						sctrans.sys_dict
					WHERE
						type = 'part_code'
					AND code = t.PART_CODE
				) TASKNAME,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				uoj.org_id orgid,
				T.PART_CODE
			FROM
				[sctrans].[T_TO_TRANS_PLAN] AS t
			LEFT JOIN sctrans.T_TO_PROPERTY_INFO AS tp ON t.case_code = tp.case_code
			LEFT JOIN sctrans.t_to_case AS k ON t.CASE_CODE = k.CASE_CODE
			LEFT JOIN sctrans.t_to_workflow AS w ON w.case_code = t.CASE_CODE
			LEFT JOIN sctrans.act_ru_task ta ON ta.[TASK_DEF_KEY_] = t.PART_CODE
			AND w.INST_CODE = ta.[PROC_INST_ID_]
			AND ta.suspension_state_ = '1'
			LEFT JOIN sctrans.LAMP_RULE l ON GETDATE() - t.EST_PART_TIME >= l.DELAYTIME
			--LEFT JOIN sctrans.SYS_USER AS u ON ta.ASSIGNEE_ = u.USERNAME
			LEFT JOIN sctrans.V_USER_ORG_JOB AS uoj ON uoj.USERNAME = ta.ASSIGNEE_
			--LEFT JOIN sctrans.SYS_ORG AS sysOrg ON sysOrg.ID = uoj.org_id
			WHERE
				uoj.org_id IS NOT NULL
			AND l.color != '2'
			GROUP BY
				t.CASE_CODE,
				k.PKID,
				t.PART_CODE,
				tp.PROPERTY_ADDR,
				uoj.REAL_NAME,
				t.EST_PART_TIME,
				ta.ID_,
				ta.PROC_INST_ID_,
				uoj.org_id
                  )as a ) t2 on t1.id=t2.orgId 
                   <ifNotNull organId>
							   where t1.id = #organId#
				  </ifNotNull>
				  <ifNotNull colourId>
							   and t2.color =#colourId#
				  </ifNotNull>
				  <ifNotNull dtBegin>
							   and t2.EST_PART_TIME >=#dtBegin#
				  </ifNotNull>
				  <ifNotNull dtEnd>
							   and t2.EST_PART_TIME &lt;=#dtEnd#
				  </ifNotNull>
				  <ifNotNull lampRadios>
							   and t2.color =#lampRadios#
				  </ifNotNull>
				  
				  <ifNotNull proOrggbName>
							   and t1.orgName1 =#proOrggbName#
				  </ifNotNull>
				  
				  <ifNotNull proOrgName>
							   and t1.orgName2 =#proOrgName#
				  </ifNotNull>
				  <ifNotNull gbName>
							   and t1.orgName1 =#gbName#
				  </ifNotNull>
				  <ifNotNull taskDfKey>
							   and t2.PART_CODE = #taskDfKey#
				  </ifNotNull>
				]]>
			</baseSql>
			<orderBySql>
			</orderBySql>
			<groupSql>
			</groupSql>
		</searchSql>
		<grid>
			<table-row>
			
			
				<column type="both" name="orgName1"  title="贵宾服务部" customDict=""  hidden="false"/>
				<column type="both" name="realName1"  title="总监" customDict="" hidden="false"/>
				<column type="both" name="orgName2"  title="组别" customDict=""  hidden="false"/>
				<column type="both" name="realName2" title="主管" customDict=""  hidden="false"/>
				
				<column type="both" name="color" title="红黄灯" customDict="" hidden="false" />
				<column type="virtual" name="color1" title="红黄灯" referencecol="color"  customDict="convertColor" hidden="false" />
				<column type="both" name="CASE_CODE"  title="案件编号" customDict=""  hidden="false"/>
				<column type="both" name="TASKNAME"  title="任务名" customDict=""  hidden="false"/>
				<column type="both" name="PROPERTY_ADDR"  title="产证地址" customDict="" hidden="false"/>
				<column type="both" name="REAL_NAME"  title="经办人" customDict="" hidden="false"/>
				<column type="both" name="EST_PART_TIME"  title="预计完成时间" customDict="" beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" hidden="false"/>
				<column type="both" name="PROPERTY_ADDR"  title="产证地址" customDict=""  hidden="false"/>
				<column type="both" name="IMPORTTIME" title="导出时间" customDict=""  beanFormatter="dateFormatter" expType="date" expFmt="yyyy-MM-dd HH:mm:ss" hidden="false"/>
				
			</table-row>
		</grid>
	</query>
	
	
</querys>
